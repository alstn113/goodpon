## 서비스 개요

- 이 시스템은 고객사의 커머스 서비스 내에서 쿠폰 서비스만 대행하는 B2B 서비스입니다.
- 전체 시스템은 Spring Kotlin 기반 멀티모듈 구조로 개발되고 있습니다.
- 메인 모듈은 다음과 같이 분리되어 있습니다:
    - partner-openapi: 가맹점(파트너) 백엔드 서버에서 사용할 API (ex. 쿠폰 발급, 사용 등)
    - dashboard-api: 가맹점 관리자들이 웹 대시보드에서 쿠폰과 상점 관리를 할 수 있는 API
- 두 모듈은 코드상으로도, 배포 주소로도 분리되어 있으며, 배포 주기도 서로 다를 수 있습니다.

## Dashboard API - 사용자 흐름

### 1. 회원 가입 및 계정 활성화, 로그인

- [x] 회원가입 요청
- [x] 이메일 인증 코드 발송
- [x] 이메일 인증 요청
    - [x] 인증 코드 재발송
- [x] 인증 완료 시 계정 활성화
    - [x] 계정 활성화 전에는 대시보드 내 주요 기능 접근 불가
- [x] 로그인 시 JWT 토큰 발급
- [x] 사용자 정보 조회 (로그인한 사용자 정보)

### 2. 상점 관리

- [ ] 내 상점 목록 조회 (최초에는 비어 있음)
- [ ] 상점 생성 (요청 시 시크릿 키 자동 생성)
- [ ] 상점 상세 정보 조회

### 3. 쿠폰 템플릿 관리

- [ ] 쿠폰 템플릿 목록 조회 (최초에는 비어 있음)
- [ ] 쿠폰 템플릿 생성 (초안 상태)
- [ ] 쿠폰 템플릿 상세 조회
- [ ] 쿠폰 템플릿 발행 (상태: draft → published)

### 4. 가맹점 백엔드(partner-openapi) 연동

- [ ] 관리자(운영자)는 발급받은 시크릿 키를 가맹점 백엔드에 등록
- [ ] 가맹점 서버에서 partner-openapi로 다음 요청 수행:
    - [ ] 쿠폰 조회
    - [ ] 쿠폰 발급 (동시성/트래픽 이슈 고려, 정책적으로 제한 존재)
    - [ ] 쿠폰 사용
    - [ ] 쿠폰 사용 취소

> ※ 엔드유저(가맹점 고객)가 쿠폰을 실제로 조회/발급/사용하는 과정은 가맹점 서버와 partner-openapi 간 상호작용으로 처리됨

### 5. 쿠폰 이력 및 페이징 조회

- [ ] 상점 전체 쿠폰 내역 조회 (대량 데이터, 페이징 필수)
- [ ] 특정 쿠폰 템플릿별로 발급/사용/취소/만료 등 전체 이력 조회
- [ ] userId 기준 사용자별 쿠폰 이력 조회
- [ ] orderId 기준 주문별 쿠폰 이력 조회

## Partner OpenAPI - 사용자 흐름

### 1. 사용자 쿠폰 목록 조회

상황: 마이페이지, 주문서 등에서 사용자가 보유한(사용 가능) 쿠폰을 조회

1. 엔드 유저 -> (웹/앱) -> 가맹점 서버
    - 내 쿠폰 목록 조회 요청 (userId 포함, 로그인 필요)
2. 가맹점 서버 -> partner-openapi
    - merchantId(시크릿키 기준), userId로 사용 가능한 쿠폰 목록 조회 API 호출
3. partner-openapi -> 가맹점 서버
    - 사용 가능한 쿠폰 목록 반환
4. 가맹점 서버 -> 엔드 유저
    - 프론트엔드 요구에 맞게 가공하여 응답

### 2. 선착순 쿠폰 템플릿 확인 및 발급

상황: 이벤트/프로모션 페이지에서 선착순 쿠폰 발급

(1) 선착순 쿠폰 정보 확인 및 발급 가능 여부 확인

1. 엔드 유저 -> (웹/앱) -> 가맹점 서버
    - 선착순 쿠폰 정보 및 발급 가능 여부 확인 요청 (userId, 템플릿ID 포함)
2. 가맹점 서버 -> partner-openapi
    - 해당 쿠폰 템플릿 정보, 발급 가능 여부 확인 API 호출
3. partner-openapi -> 가맹점 서버
    - 쿠폰 템플릿 정보와 사용자의 발급 여부 응답
4. 가맹점 서버 -> 엔드 유저
    - 쿠폰 템플릿 정보와 발급 가능 여부 응답

(2) 쿠폰 발급 요청

1. 엔드 유저 -> (웹/앱) -> 가맹점 서버
    - 쿠폰 발급 요청 (사용자 정보 포함)
2. 가맹점 서버 -> partner-openapi
    - 쿠폰 발급 요청 (쿠폰 템플릿 ID, 사용자 정보 포함)
3. partner-openapi -> 가맹점 서버
    - 쿠폰 발급 성공 응답 (쿠폰 ID 포함)
    - 쿠폰 발급 실패 응답 (예: 이미 발급된 경우, 발급 한도 초과 등)
4. 가맹점 서버 -> 엔드 유저
    - 쿠폰 발급 성공/실패 응답 (프론트 요구사항에 맞게 가공)

### 3. 주문서에서 사용 가능한 쿠폰 목록 조회

상황: 장바구니/주문서 작성 시, 해당 주문에 적용 가능한 쿠폰만 조회 (할인 금액 확인)

1. 엔드 유저 -> (웹/앱) -> 가맹점 서버
    - 주문서 작성 페이지에서 사용 가능한 쿠폰 목록 조회
2. 가맹점 서버 -> partner-openapi
    - 총 구매 금액과 사용자 정보로 사용 가능한 쿠폰 목록 조회 요청
3. partner-openapi -> 가맹점 서버
    - 사용 가능한 쿠폰 목록 응답 + (할인 금액, 최종 결제 금액 등 추가 정보)
4. 가맹점 서버 -> 엔드 유저
    - 프론트 요구사항에 맞게 가공/필터링(예: 정렬, 추천) 후 응답

### 4. 쿠폰 사용

상황: 결제 확정 시 쿠폰 사용

1. 엔드 유저 -> (웹/앱) -> 가맹점 서버
    - "쿠폰 적용하여 결제" 요청 (userId, orderId, couponId 등 전달)
2. 가맹점 서버 -> partner-openapi
    - 쿠폰 사용 요청 (userId, couponId, orderId 등)
3. partner-openapi -> 가맹점 서버
    - 쿠폰 사용 성공 응답 (쿠폰 ID, 사용 금액 등 포함)
    - 쿠폰 사용 실패 응답 (예: 이미 사용된 쿠폰, 유효 기간 만료 등)
4. 가맹점 서버 → 결제 서버
    - 결제 승인 요청(쿠폰이 적용된 금액으로)
5. (결제 실패 시) 가맹점 서버 -> partner-openapi
    - 쿠폰 사용 취소 요청 (쿠폰 ID, 취소 이유 ex. 결제 실패)
6. 가맹점 서버 -> 엔드 유저
    - 결제 성공 응답 (쿠폰 사용 금액 포함)
    - 결제 실패 응답 (쿠폰 사용 취소 포함, 사용자에게 알림)